#!/usr/bin/env bash

PKG_FILE="$DOTFILES/pkgs.txt"
PKG_ALL_FILE="$DOTFILES/pkgs-all.txt"
MIGRATION_DIR="$DOTFILES/pkg_migrations"

EXCLUDE_PATTERNS=(
    # PHP7 has to manually installed
    "php74*"
    # Not always a amd machine
    "amd-ucode"
    # Will need paru to install, so no need to reinstall it self
    "paru*"
    # Well, my working machine should not have steam
    "steam"
    # If not dual boot windows with arch, no need
    "os-prober"
    # Working PC no need chinese keyboard
    "*rime*"
    "*fcitx5*"
    # No need all the browsers
    "chromium"
    "firefox"
    "chrome"
    # Manual install
    "yay*"
)

# Ensure paru is installed
function ensure_paru() {
    if ! command -v paru &>/dev/null; then
        echo "Paru is not installed. Installing paru..."
        sudo pacman -Sy --needed --noconfirm base-devel git
        tmpdir=$(mktemp -d)
        git clone https://aur.archlinux.org/paru.git "$tmpdir/paru"
        pushd "$tmpdir/paru" >/dev/null || exit 1
        makepkg -si --noconfirm
        popd >/dev/null || exit
        rm -rf "$tmpdir"
        echo "Paru installed successfully."
    else
        echo "Paru is already installed."
    fi
}

function create_migration() {
    local old_file="$1"
    local new_file="$2"
    local timestamp
    timestamp=$(date +"%Y%m%d_%H%M%S")
    local migration_file="$MIGRATION_DIR/${timestamp}_pkg_migration.sh"

    # Ensure migration directory exists
    mkdir -p "$MIGRATION_DIR"

    # Read old and new package lists
    local -a old_pkgs new_pkgs
    if [[ -f "$old_file" ]]; then
        mapfile -t old_pkgs <"$old_file"
    fi
    mapfile -t new_pkgs <"$new_file"

    # Find added and removed packages
    local -a added removed

    # Find added packages (in new but not in old)
    for pkg in "${new_pkgs[@]}"; do
        local found=false
        for old_pkg in "${old_pkgs[@]}"; do
            if [[ "$pkg" == "$old_pkg" ]]; then
                found=true
                break
            fi
        done
        if ! $found; then
            added+=("$pkg")
        fi
    done

    # Find removed packages (in old but not in new)
    for pkg in "${old_pkgs[@]}"; do
        local found=false
        for new_pkg in "${new_pkgs[@]}"; do
            if [[ "$pkg" == "$new_pkg" ]]; then
                found=true
                break
            fi
        done
        if ! $found; then
            removed+=("$pkg")
        fi
    done

    # Only create migration if there are changes
    if [[ ${#added[@]} -eq 0 && ${#removed[@]} -eq 0 ]]; then
        echo "No package changes detected. No migration created."
        return
    fi

    # Create migration file
    cat >"$migration_file" <<'EOF'
#!/usr/bin/env bash
set -e

echo "Running package migration: $(basename "$0")"
echo "========================================"

EOF

    # Add removal commands
    if [[ ${#removed[@]} -gt 0 ]]; then
        cat >>"$migration_file" <<EOF

echo "Removing ${#removed[@]} package(s)..."
EOF
        for pkg in "${removed[@]}"; do
            echo "err=\$(paru -Rns --noconfirm '$pkg' 2>&1) || echo \"\$err\"" >>"$migration_file"
        done
    fi

    # Add installation commands
    if [[ ${#added[@]} -gt 0 ]]; then
        cat >>"$migration_file" <<EOF

echo "Installing ${#added[@]} package(s)..."
EOF
        for pkg in "${added[@]}"; do
            echo "paru -S --needed --noconfirm '$pkg'" >>"$migration_file"
        done
    fi

    cat >>"$migration_file" <<'EOF'

echo "========================================"
echo "Migration completed successfully!"
EOF

    # Make migration executable
    chmod +x "$migration_file"

    echo ""
    echo "Migration created: $migration_file"
    echo "  - Added: ${#added[@]} package(s)"
    echo "  - Removed: ${#removed[@]} package(s)"
    echo ""
    echo "To apply this migration, run: $migration_file"
}

function save_packages() {
    echo "Saving explicitly installed packages..."
    local all_pkgs
    mapfile -t all_pkgs < <(pacman -Qqe)

    # Create temporary files for new package lists
    local tmp_all
    tmp_all=$(mktemp)
    local tmp_filtered
    tmp_filtered=$(mktemp)

    # Save complete package list to temp
    printf "%s\n" "${all_pkgs[@]}" >"$tmp_all"

    # Save filtered package list to temp
    local filtered_pkgs=()
    for pkg in "${all_pkgs[@]}"; do
        local skip=false
        for pattern in "${EXCLUDE_PATTERNS[@]}"; do
            # Intentional glob pattern matching - do not quote
            # shellcheck disable=SC2053
            if [[ $pkg == $pattern ]]; then
                echo "Excluding package: $pkg"
                skip=true
                break
            fi
        done
        if ! $skip; then
            filtered_pkgs+=("$pkg")
        fi
    done
    printf "%s\n" "${filtered_pkgs[@]}" >"$tmp_filtered"

    # Create migrations before updating files
    echo ""
    echo "Checking for package changes..."
    create_migration "$PKG_FILE" "$tmp_filtered"

    # Move temp files to actual files
    mv "$tmp_all" "$PKG_ALL_FILE"
    mv "$tmp_filtered" "$PKG_FILE"

    echo ""
    echo "Saved $(wc -l <"$PKG_ALL_FILE") packages to $PKG_ALL_FILE (complete list)."
    echo "Saved $(wc -l <"$PKG_FILE") packages to $PKG_FILE (filtered list, excludes: ${EXCLUDE_PATTERNS[*]})."
}

function install_packages() {
    local use_all=false
    local target_file="$PKG_FILE"

    # Parse the all flag
    if [[ "$1" == "--all" ]]; then
        use_all=true
        target_file="$PKG_ALL_FILE"
    fi

    if [[ ! -f "$target_file" ]]; then
        echo "Error: $target_file not found. Please run with 'save' first."
        exit 1
    fi

    ensure_paru

    if $use_all; then
        echo "Installing ALL packages from $target_file using paru..."
    else
        echo "Installing filtered packages from $target_file using paru..."
    fi

    paru -S --needed --noconfirm - <"$target_file"
    echo "Packages installed successfully."
}

function usage() {
    echo "Usage: $0 {save|install [--all]}"
    echo "  save           - Save packages to both $PKG_FILE (filtered) and $PKG_ALL_FILE (complete)"
    echo "                   Creates migration file in $MIGRATION_DIR if changes detected"
    echo "  install        - Install filtered packages from $PKG_FILE using paru"
    echo "  install --all  - Install all packages from $PKG_ALL_FILE using paru"
    echo ""
    echo "The script automatically installs paru if needed during install operations."
    echo "Migration files are created automatically and can be run independently to apply changes."
}

# Main
case "$1" in
save)
    save_packages
    ;;
install)
    install_packages "$2"
    ;;
*)
    usage
    exit 1
    ;;
esac
